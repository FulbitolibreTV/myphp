<?php// dashjs.php - Dash.js Player Implementationheader('X-Frame-Options: SAMEORIGIN');header('Content-Type: text/html; charset=UTF-8');// Obtener parámetros$src = $_GET['src'] ?? '';$type = $_GET['type'] ?? 'mpd';$provider = $_GET['provider'] ?? 'direct';$autoplay = $_GET['autoplay'] ?? '0';$controls = $_GET['controls'] ?? '1';if (empty($src)) {    die('<div style="text-align:center;padding:50px;color:#fff;background:#000;">? No se proporcionó URL de video</div>');}// Función para procesar URLs según el proveedorfunction processVideoURL($src, $provider) {    switch ($provider) {        case 'gdrive':            if (strpos($src, 'drive.google.com') !== false) {                preg_match('/\/d\/([a-zA-Z0-9-_]+)/', $src, $matches);                $fileId = $matches[1] ?? $src;            } else {                $fileId = $src;            }            return "https://drive.google.com/uc?export=download&id=" . $fileId;                    case 'dropbox':            return str_replace(['?dl=0', '?dl=1'], '?dl=1', $src);                    case 'onedrive':            return str_replace('/view?', '/download?', $src);                    default:            return $src;    }}$processedSrc = processVideoURL($src, $provider);$playerId = 'dashplayer_' . uniqid();?><!DOCTYPE html><html lang="es"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>DASH Player</title>    <style>        * { margin: 0; padding: 0; box-sizing: border-box; }        body {             background: #000;             font-family: Arial, sans-serif;             display: flex;             justify-content: center;             align-items: center;             min-height: 100vh;         }        .player-container {             width: 100%;             max-width: 100%;             position: relative;             background: #000;            border-radius: 8px;            overflow: hidden;        }        video {            width: 100%;            height: auto;            display: block;            background: #000;        }        .error-container {            background: #1a1a1a;            color: #ff6b6b;            padding: 40px 20px;            text-align: center;            border-radius: 8px;        }        .loading {            color: #fff;            text-align: center;            padding: 40px 20px;            background: #1a1a1a;            border-radius: 8px;        }        .dash-info {            position: absolute;            top: 10px;            right: 10px;            background: rgba(0,0,0,0.8);            color: #ff6600;            padding: 5px 10px;            border-radius: 4px;            font-size: 11px;            font-family: monospace;        }        .controls-overlay {            position: absolute;            top: 10px;            left: 10px;            z-index: 1000;            display: flex;            gap: 10px;        }        .control-select {            background: rgba(0,0,0,0.8);            color: white;            border: 1px solid #555;            border-radius: 4px;            padding: 5px;            font-size: 12px;        }    </style>    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script></head><body>    <div class="player-container">        <div id="loading" class="loading">?? Inicializando DASH Player...</div>        <video             id="<?= $playerId ?>"             <?= $controls === '1' ? 'controls' : '' ?>            <?= $autoplay === '1' ? 'autoplay muted' : '' ?>            preload="metadata"            playsinline            style="display: none;"        >            Tu navegador no soporta la reproducción de video HTML5.        </video>                <div class="dash-info" id="dashInfo" style="display: none;">            DASH        </div>                <div class="controls-overlay" id="controlsOverlay" style="display: none;">            <select id="qualitySelect" class="control-select">                <option value="auto">Calidad: Auto</option>            </select>            <select id="audioSelect" class="control-select" style="display: none;">                <option value="auto">Audio: Auto</option>            </select>        </div>    </div>    <script>        document.addEventListener('DOMContentLoaded', function() {            const video = document.getElementById('<?= $playerId ?>');            const loading = document.getElementById('loading');            const dashInfo = document.getElementById('dashInfo');            const controlsOverlay = document.getElementById('controlsOverlay');            const qualitySelect = document.getElementById('qualitySelect');            const audioSelect = document.getElementById('audioSelect');                        const videoSrc = '<?= addslashes($processedSrc) ?>';            const autoplay = <?= $autoplay === '1' ? 'true' : 'false' ?>;                        let player = null;            function showError(message, details = '') {                document.querySelector('.player-container').innerHTML = `                    <div class="error-container">                        <h3>? Error DASH Player</h3>                        <p>${message}</p>                        ${details ? `<p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">${details}</p>` : ''}                        <br>                        <p><strong>URL:</strong> <?= htmlspecialchars($processedSrc) ?></p>                        <p><strong>Tipo:</strong> <?= strtoupper($type) ?></p>                        <p><strong>Proveedor:</strong> <?= ucfirst($provider) ?></p>                        <br>                        <a href="<?= htmlspecialchars($processedSrc) ?>" target="_blank" style="color: #4fc3f7;">                            ?? Abrir enlace directo                        </a>                    </div>                `;            }            function hideLoading() {                loading.style.display = 'none';                video.style.display = 'block';            }            try {                // Crear instancia de DASH.js                player = dashjs.MediaPlayer().create();                                // Configuraciones del player                player.getDebug().setLogToBrowserConsole(false);                                // Configurar adaptación automática                player.updateSettings({                    'streaming': {                        'abr': {                            'autoSwitchBitrate': {                                'video': true,                                'audio': true                            }                        },                        'buffer': {                            'bufferTimeAtTopQuality': 30,                            'bufferTimeAtTopQualityLongForm': 60                        }                    }                });                // Eventos del player                player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, function() {                    console.log('DASH Stream initialized');                    hideLoading();                    dashInfo.style.display = 'block';                    controlsOverlay.style.display = 'block';                                        // Configurar selectores de calidad y audio                    setupQualitySelector();                    setupAudioSelector();                                        if (autoplay) {                        video.play().catch(e => {                            console.log('Autoplay failed:', e);                        });                    }                });                player.on(dashjs.MediaPlayer.events.ERROR, function(e) {                    console.error('DASH Error:', e);                    showError('Error en DASH Player', `Código: ${e.error?.code || 'Desconocido'}`);                });                player.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, function(e) {                    if (e.mediaType === 'video') {                        const bitrate = Math.round(e.newQuality.bitrate / 1000);                        const resolution = `${e.newQuality.width}x${e.newQuality.height}`;                        dashInfo.textContent = `DASH ${resolution} (${bitrate}k)`;                    }                });                // Inicializar el player                player.initialize(video, videoSrc, autoplay);                function setupQualitySelector() {                    const bitrateInfoList = player.getBitrateInfoListFor('video');                                        if (bitrateInfoList && bitrateInfoList.length > 1) {                        // Limpiar opciones existentes                        qualitySelect.innerHTML = '<option value="auto">Calidad: Auto</option>';                                                // Agregar opciones de calidad                        bitrateInfoList.forEach((bitrate, index) => {                            const option = document.createElement('option');                            option.value = index;                            const resolution = `${bitrate.width}x${bitrate.height}`;                            const bitrateValue = Math.round(bitrate.bitrate / 1000);                            option.text = `${resolution} (${bitrateValue}k)`;                            qualitySelect.appendChild(option);                        });                                                qualitySelect.style.display = 'block';                    }                }                function setupAudioSelector() {                    const audioTracks = player.getTracksFor('audio');                                        if (audioTracks && audioTracks.length > 1) {                        // Limpiar opciones existentes                        audioSelect.innerHTML = '<option value="auto">Audio: Auto</option>';                                                // Agregar pistas de audio                        audioTracks.forEach((track, index) => {                            const option = document.createElement('option');                            option.value = index;                            option.text = `${track.lang || 'Desconocido'} (${track.codec || 'Audio'})`;                            audioSelect.appendChild(option);                        });                                                audioSelect.style.display = 'block';                    }                }                // Manejar cambio de calidad                qualitySelect.addEventListener('change', function() {                    const selectedIndex = parseInt(this.value);                    if (isNaN(selectedIndex)) {                        // Auto                        player.updateSettings({                            'streaming': {                                'abr': {                                    'autoSwitchBitrate': { 'video': true }                                }                            }                        });                    } else {                        // Calidad fija                        player.updateSettings({                            'streaming': {                                'abr': {                                    'autoSwitchBitrate': { 'video': false }                                }                            }                        });                        player.setQualityFor('video', selectedIndex);                    }                });                // Manejar cambio de audio                audioSelect.addEventListener('change', function() {                    const selectedIndex = parseInt(this.value);                    if (!isNaN(selectedIndex)) {                        player.setCurrentTrack(player.getTracksFor('audio')[selectedIndex]);                    }                });            } catch (error) {                console.error('Error inicializando DASH Player:', error);                showError('Error al inicializar DASH Player', error.message);            }            // Eventos del video            video.addEventListener('loadstart', () => {                console.log('Video load started');            });            video.addEventListener('canplay', () => {                console.log('Video can play');            });            video.addEventListener('error', (e) => {                console.error('Video error:', e);                showError('Error al cargar el video', 'Verifica que la URL del manifest DASH sea válida');            });            video.addEventListener('waiting', () => {                console.log('Video waiting for data...');            });            video.addEventListener('playing', () => {                console.log('Video playing');            });            // Cleanup al salir            window.addEventListener('beforeunload', () => {                if (player) {                    player.destroy();                }            });        });    </script></body></html>