<?php// hls.php - HLS.js Player Implementationheader('X-Frame-Options: SAMEORIGIN');header('Content-Type: text/html; charset=UTF-8');// Obtener parámetros$src = $_GET['src'] ?? '';$type = $_GET['type'] ?? 'm3u8';$provider = $_GET['provider'] ?? 'direct';$autoplay = $_GET['autoplay'] ?? '0';$controls = $_GET['controls'] ?? '1';if (empty($src)) {    die('<div style="text-align:center;padding:50px;color:#fff;background:#000;">? No se proporcionó URL de video</div>');}// Función para procesar URLs según el proveedorfunction processVideoURL($src, $provider) {    switch ($provider) {        case 'gdrive':            if (strpos($src, 'drive.google.com') !== false) {                preg_match('/\/d\/([a-zA-Z0-9-_]+)/', $src, $matches);                $fileId = $matches[1] ?? $src;            } else {                $fileId = $src;            }            return "https://drive.google.com/uc?export=download&id=" . $fileId;                    case 'dropbox':            return str_replace(['?dl=0', '?dl=1'], '?dl=1', $src);                    case 'onedrive':            return str_replace('/view?', '/download?', $src);                    case 'm3u8':        case 'rtmp':        case 'direct':        default:            return $src;    }}$processedSrc = processVideoURL($src, $provider);$playerId = 'hlsplayer_' . uniqid();?><!DOCTYPE html><html lang="es"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>HLS Player</title>    <style>        * { margin: 0; padding: 0; box-sizing: border-box; }        body {             background: #000;             font-family: Arial, sans-serif;             display: flex;             justify-content: center;             align-items: center;             min-height: 100vh;         }        .player-container {             width: 100%;             max-width: 100%;             position: relative;             background: #000;            border-radius: 8px;            overflow: hidden;        }        video {            width: 100%;            height: auto;            display: block;            background: #000;        }        .error-container {            background: #1a1a1a;            color: #ff6b6b;            padding: 40px 20px;            text-align: center;            border-radius: 8px;        }        .loading {            color: #fff;            text-align: center;            padding: 40px 20px;            background: #1a1a1a;            border-radius: 8px;        }        .hls-info {            position: absolute;            top: 10px;            right: 10px;            background: rgba(0,0,0,0.8);            color: #00ff88;            padding: 5px 10px;            border-radius: 4px;            font-size: 11px;            font-family: monospace;        }        .quality-selector {            position: absolute;            top: 10px;            left: 10px;            z-index: 1000;        }        .quality-selector select {            background: rgba(0,0,0,0.8);            color: white;            border: 1px solid #555;            border-radius: 4px;            padding: 5px;            font-size: 12px;        }    </style>    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script></head><body>    <div class="player-container">        <div id="loading" class="loading">?? Inicializando HLS Player...</div>        <video             id="<?= $playerId ?>"             <?= $controls === '1' ? 'controls' : '' ?>            <?= $autoplay === '1' ? 'autoplay muted' : '' ?>            preload="metadata"            playsinline            style="display: none;"        >            Tu navegador no soporta la reproducción de video HTML5.        </video>                <div class="hls-info" id="hlsInfo" style="display: none;">            HLS LIVE        </div>                <div class="quality-selector" id="qualitySelector" style="display: none;">            <select id="qualitySelect">                <option value="-1">Auto</option>            </select>        </div>    </div>    <script>        document.addEventListener('DOMContentLoaded', function() {            const video = document.getElementById('<?= $playerId ?>');            const loading = document.getElementById('loading');            const hlsInfo = document.getElementById('hlsInfo');            const qualitySelector = document.getElementById('qualitySelector');            const qualitySelect = document.getElementById('qualitySelect');                        const videoSrc = '<?= addslashes($processedSrc) ?>';            const autoplay = <?= $autoplay === '1' ? 'true' : 'false' ?>;                        let hls = null;            function showError(message, details = '') {                document.querySelector('.player-container').innerHTML = `                    <div class="error-container">                        <h3>? Error HLS Player</h3>                        <p>${message}</p>                        ${details ? `<p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">${details}</p>` : ''}                        <br>                        <p><strong>URL:</strong> <?= htmlspecialchars($processedSrc) ?></p>                        <p><strong>Proveedor:</strong> <?= ucfirst($provider) ?></p>                        <br>                        <a href="<?= htmlspecialchars($processedSrc) ?>" target="_blank" style="color: #4fc3f7;">                            ?? Abrir enlace directo                        </a>                    </div>                `;            }            function hideLoading() {                loading.style.display = 'none';                video.style.display = 'block';            }            if (Hls.isSupported()) {                console.log('HLS.js soportado');                                hls = new Hls({                    debug: false,                    enableWorker: true,                    lowLatencyMode: true,                    backBufferLength: 90                });                // Cargar la fuente                hls.loadSource(videoSrc);                hls.attachMedia(video);                // Eventos de HLS                hls.on(Hls.Events.MEDIA_ATTACHED, () => {                    console.log('HLS Media attached');                });                hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {                    console.log('HLS Manifest parsed, found ' + data.levels.length + ' quality levels');                    hideLoading();                    hlsInfo.style.display = 'block';                                        // Configurar selector de calidad                    if (data.levels.length > 1) {                        qualitySelector.style.display = 'block';                                                // Limpiar opciones existentes (mantener Auto)                        qualitySelect.innerHTML = '<option value="-1">Auto</option>';                                                // Agregar niveles de calidad                        data.levels.forEach((level, index) => {                            const option = document.createElement('option');                            option.value = index;                            option.text = `${level.height}p (${Math.round(level.bitrate/1000)}k)`;                            qualitySelect.appendChild(option);                        });                    }                                        // Autoplay si está habilitado                    if (autoplay) {                        video.play().catch(e => {                            console.log('Autoplay failed:', e);                        });                    }                });                hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {                    console.log('Level switched to:', data.level);                    const level = hls.levels[data.level];                    if (level) {                        hlsInfo.textContent = `HLS ${level.height}p`;                    }                });                hls.on(Hls.Events.ERROR, (event, data) => {                    console.error('HLS Error:', data);                                        if (data.fatal) {                        switch (data.type) {                            case Hls.ErrorTypes.NETWORK_ERROR:                                console.log('Network error encountered, trying to recover...');                                hls.startLoad();                                break;                            case Hls.ErrorTypes.MEDIA_ERROR:                                console.log('Media error encountered, trying to recover...');                                hls.recoverMediaError();                                break;                            default:                                showError('Error fatal en HLS', `Tipo: ${data.type}, Detalles: ${data.details}`);                                hls.destroy();                                break;                        }                    }                });                // Manejar cambio de calidad                qualitySelect.addEventListener('change', function() {                    const selectedLevel = parseInt(this.value);                    if (selectedLevel === -1) {                        hls.currentLevel = -1; // Auto                    } else {                        hls.currentLevel = selectedLevel;                    }                });            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {                // Safari nativo HLS                console.log('Safari HLS nativo');                video.src = videoSrc;                hideLoading();                hlsInfo.style.display = 'block';                hlsInfo.textContent = 'HLS NATIVO';                                if (autoplay) {                    video.play().catch(e => {                        console.log('Autoplay failed:', e);                    });                }            } else {                showError('HLS no soportado', 'Tu navegador no soporta reproducción HLS');            }            // Eventos del video            video.addEventListener('loadstart', () => {                console.log('Video load started');            });            video.addEventListener('canplay', () => {                console.log('Video can play');                hideLoading();            });            video.addEventListener('error', (e) => {                console.error('Video error:', e);                showError('Error al cargar el video', 'Verifica que la URL del stream sea válida');            });            video.addEventListener('waiting', () => {                console.log('Video waiting for data...');            });            video.addEventListener('playing', () => {                console.log('Video playing');            });            // Cleanup al salir            window.addEventListener('beforeunload', () => {                if (hls) {                    hls.destroy();                }            });        });    </script></body></html>