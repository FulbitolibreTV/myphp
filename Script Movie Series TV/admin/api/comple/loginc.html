<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Cargando...</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
  /* Reset y estilo base */
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Orbitron', sans-serif;
    background: #0e0e0e;
    color: #fff;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 0 10px;
  }
  header {
    width: 100%;
    background: #111;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 0 15px rgba(0,255,255,0.3);
    position: fixed;
    top: 0;
    z-index: 1000;
  }
  header .logo {
    font-size: 1.8rem;
    color: #00ffe0;
    font-weight: 700;
    text-shadow: 0 0 5px #00ffe0;
  }
  
  .user-info {
    display: none;
    align-items: center;
    gap: 15px;
  }
  
  .welcome-text {
    color: #0ff;
    font-size: 0.9rem;
  }
  
  .logout-btn {
    padding: 8px 15px;
    background: transparent;
    border: 1px solid #ff4444;
    border-radius: 6px;
    color: #ff4444;
    cursor: pointer;
    font-family: 'Orbitron', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .logout-btn:hover {
    background: #ff4444;
    color: #111;
    transform: translateY(-1px);
  }
  
  /* Contenedor principal ajustado por header fijo */
  .main-container {
    margin-top: 80px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  /* Pantalla de sesión iniciada */
  .session-container {
    display: none;
    background: #111;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,255,255,0.3);
    width: 100%;
    max-width: 400px;
    text-align: center;
  }
  
  .session-container h2 {
    color: #00ffe0;
    margin-bottom: 20px;
    text-shadow: 0 0 5px #00ffe0;
  }
  
  .user-details {
    background: rgba(0,255,224,0.1);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #00ffe0;
    margin: 20px 0;
  }
  
  .access-button {
    width: 100%;
    padding: 15px;
    background: linear-gradient(45deg, #00ffe0, #0ff);
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #111;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 10px 0;
  }
  
  .access-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,255,224,0.3);
  }
  
  /* Login container */
  .login-container {
    background: #111;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(0,255,255,0.3);
    width: 100%;
    max-width: 380px;
    transition: all 0.3s ease;
  }
  .login-container h2 {
    color: #00ffe0;
    margin-bottom: 20px;
    text-align: center;
    text-shadow: 0 0 5px #00ffe0;
  }
  label {
    display: block;
    margin-bottom: 5px;
    color: #0ff;
    font-weight: 600;
  }
  input {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 18px;
    border: 1px solid #0ff;
    border-radius: 8px;
    background: #111;
    color: #fff;
    font-size: 1rem;
  }
  input:focus {
    outline: none;
    border-color: #00ffe0;
    box-shadow: 0 0 8px #00ffe0;
  }
  
  /* Checkbox personalizado para guardar datos */
  .checkbox-container {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    user-select: none;
    cursor: pointer;
  }
  
  .checkbox-container input[type="checkbox"] {
    display: none;
  }
  
  .checkmark {
    height: 20px;
    width: 20px;
    background-color: transparent;
    border: 2px solid #0ff;
    border-radius: 4px;
    margin-right: 10px;
    position: relative;
    transition: all 0.3s ease;
  }
  
  .checkbox-container:hover .checkmark {
    border-color: #00ffe0;
    box-shadow: 0 0 5px rgba(0,255,224,0.3);
  }
  
  .checkbox-container input:checked ~ .checkmark {
    background-color: #00ffe0;
    border-color: #00ffe0;
  }
  
  .checkmark:after {
    content: "";
    position: absolute;
    display: none;
  }
  
  .checkbox-container input:checked ~ .checkmark:after {
    display: block;
  }
  
  .checkbox-container .checkmark:after {
    left: 6px;
    top: 2px;
    width: 4px;
    height: 8px;
    border: solid #111;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }
  
  .checkbox-label {
    color: #0ff;
    font-size: 0.9rem;
    font-weight: 400;
  }

  button {
    width: 100%;
    padding: 12px;
    background: #00ffe0;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 700;
    color: #111;
    cursor: pointer;
    transition: 0.3s;
  }
  button:hover {
    background: #0ff;
    transform: translateY(-2px);
  }
  
  /* Botón para limpiar datos guardados */
  .clear-data-btn {
    width: 100%;
    padding: 10px;
    background: transparent;
    border: 1px solid #ff4444;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    color: #ff4444;
    cursor: pointer;
    transition: 0.3s;
    margin-top: 10px;
    display: none;
  }
  .clear-data-btn:hover {
    background: #ff4444;
    color: #111;
    transform: translateY(-1px);
  }
  
  .login-footer {
    margin-top: 15px;
    text-align: center;
    font-size: 0.9rem;
  }
  .login-footer a {
    color: #00ffe0;
    text-decoration: none;
    font-weight: 600;
  }
  .login-footer a:hover {
    color: #0ff;
    text-shadow: 0 0 5px #0ff;
  }
  
  /* Contador de intentos */
  .attempts-warning {
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid #ff4444;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    color: #ff4444;
    text-align: center;
    font-size: 0.9rem;
    display: none;
  }
  
  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.8);
  }
  .modal-content {
    background: #111;
    margin: 20% auto;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 350px;
    color: #0ff;
    text-align: center;
    box-shadow: 0 0 20px #00ffe0;
    animation: fadeIn 0.4s ease;
  }
  .modal-content button {
    margin-top: 15px;
    padding: 10px 15px;
    background: #00ffe0;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    color: #111;
    transition: 0.3s;
  }
  .modal-content button:hover { background: #0ff; }
  
  /* Modal de confirmación */
  .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 15px;
  }
  
  .modal-btn-cancel {
    background: transparent !important;
    border: 1px solid #ff4444 !important;
    color: #ff4444 !important;
  }
  
  .modal-btn-cancel:hover {
    background: #ff4444 !important;
    color: #111 !important;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Media queries para móviles */
  @media (max-width: 480px){
    .login-container { padding: 20px; }
    .session-container { padding: 20px; }
    header .logo { font-size: 1.6rem; }
    input, button { font-size: 0.95rem; padding: 10px; }
    .modal-content { margin: 25% auto; }
    .main-container { margin-top: 70px; }
    
    .user-info {
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }
    
    .welcome-text {
      font-size: 0.8rem;
    }
    
    .logout-btn {
      font-size: 0.75rem;
      padding: 6px 12px;
    }
    
    /* Input numérico para PIN en móviles */
    #pin {
      font-size: 1.2rem;
      text-align: center;
      letter-spacing: 2px;
    }
  }
</style>
</head>
<body>

<header>
  <div class="logo" id="site-title">Cargando...</div>
  <div class="user-info" id="userInfo">
    <div class="welcome-text" id="welcomeText"></div>
    <button class="logout-btn" onclick="showLogoutModal()">
      <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
    </button>
  </div>
</header>

<div class="main-container">
  <!-- Pantalla de sesión iniciada -->
  <div class="session-container" id="sessionContainer">
    <h2><i class="fas fa-check-circle"></i> Sesión Activa</h2>
    <div class="user-details" id="userDetails"></div>
    <button class="access-button" onclick="redirectToMovies()">
      <i class="fas fa-play"></i> Acceder a Películas
    </button>
  </div>

  <!-- Pantalla de login -->
  <div class="login-container" id="loginContainer">
    <h2>Login Clientes</h2>
    
    <!-- Alerta de intentos -->
    <div class="attempts-warning" id="attemptsWarning"></div>
    
    <form id="loginForm">
      <label for="usuario">Usuario</label>
      <input type="text" id="usuario" name="usuario" required placeholder="Ingrese su usuario" autocomplete="username">

      <label for="pin">PIN</label>
      <input type="tel" id="pin" name="pin" required placeholder="Ingrese su PIN" 
             pattern="[0-9]*" inputmode="numeric" maxlength="10" autocomplete="current-password">

      <!-- Checkbox para guardar datos -->
      <label class="checkbox-container">
        <input type="checkbox" id="saveData">
        <span class="checkmark"></span>
        <span class="checkbox-label">Recordar mis datos</span>
      </label>

      <button type="submit"><i class="fas fa-key"></i> Ingresar</button>
      
      <!-- Botón para limpiar datos guardados -->
      <button type="button" class="clear-data-btn" id="clearDataBtn">
        <i class="fas fa-trash"></i> Limpiar datos guardados
      </button>
    </form>

    <div class="login-footer">
      ¿No tienes cuenta? 
      <a href="https://wa.me/573245945588?text=Hola,%20quiero%20comprar%20una%20cuenta" target="_blank">Comprar usuario</a>
    </div>
  </div>
</div>

<!-- Modal genérico -->
<div id="loginModal" class="modal">
  <div class="modal-content" id="modalMessage">
    <p id="modalText"></p>
    <button onclick="closeModal()">Aceptar</button>
  </div>
</div>

<!-- Modal de confirmación de logout -->
<div id="logoutModal" class="modal">
  <div class="modal-content">
    <p>¿Estás seguro de que quieres cerrar sesión?</p>
    <div class="modal-buttons">
      <button class="modal-btn-cancel" onclick="closeLogoutModal()">Cancelar</button>
      <button onclick="confirmLogout()">Cerrar Sesión</button>
    </div>
  </div>
</div>

<script>
// Variables globales
const STORAGE_KEY = 'login_data_corpsrtony';
const SESSION_KEY = 'user_session_corpsrtony';
const ATTEMPTS_KEY = 'login_attempts_corpsrtony';
const MAX_ATTEMPTS = 5;

let loginAttempts = 0;

// Cargar nombre del sitio desde site_info.json remoto
fetch("https://prueba.corpsrtony.com/admin/api/site_info.php")
  .then(res => res.json())
  .then(site => {
    document.getElementById("site-title").textContent = site.title || "CorpSRTony";
    if(site.favicon){
      const link = document.createElement("link");
      link.rel = "icon";
      link.href = site.favicon;
      document.head.appendChild(link);
    }
  });

// Función para cargar datos guardados
function loadSavedData() {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      const savedData = JSON.parse(stored);
      document.getElementById("usuario").value = savedData.usuario || '';
      document.getElementById("pin").value = savedData.pin || '';
      document.getElementById("saveData").checked = true;
      
      if (savedData.usuario || savedData.pin) {
        document.getElementById("clearDataBtn").style.display = 'block';
      }
    }
  } catch (error) {
    console.error('Error cargando datos guardados:', error);
  }
}

// Función para guardar datos solo cuando se marca el checkbox
function saveDataIfChecked() {
  const shouldSave = document.getElementById("saveData").checked;
  const usuario = document.getElementById("usuario").value.trim();
  const pin = document.getElementById("pin").value.trim();

  if (shouldSave && (usuario || pin)) {
    try {
      const dataToSave = { usuario, pin };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
      document.getElementById("clearDataBtn").style.display = 'block';
    } catch (error) {
      console.error('Error guardando datos:', error);
    }
  } else if (!shouldSave) {
    clearSavedData();
  }
}

// Función para limpiar datos guardados
function clearSavedData() {
  try {
    localStorage.removeItem(STORAGE_KEY);
    document.getElementById("clearDataBtn").style.display = 'none';
    document.getElementById("saveData").checked = false;
  } catch (error) {
    console.error('Error eliminando datos:', error);
  }
}

// Función para verificar sesión activa
function checkActiveSession() {
  try {
    const session = localStorage.getItem(SESSION_KEY);
    if (session) {
      const sessionData = JSON.parse(session);
      showSessionScreen(sessionData);
      return true;
    }
  } catch (error) {
    console.error('Error verificando sesión:', error);
  }
  return false;
}

// Función para mostrar pantalla de sesión
function showSessionScreen(sessionData) {
  document.getElementById("loginContainer").style.display = 'none';
  document.getElementById("sessionContainer").style.display = 'block';
  document.getElementById("userInfo").style.display = 'flex';
  
  document.getElementById("welcomeText").textContent = `Bienvenido, ${sessionData.usuario}`;
  
  let details = `<strong>Usuario:</strong> ${sessionData.usuario}<br>`;
  if (sessionData.days_left !== undefined) {
    details += `<strong>Días restantes:</strong> ${sessionData.days_left}`;
  }
  document.getElementById("userDetails").innerHTML = details;
}

// Función para mostrar pantalla de login
function showLoginScreen() {
  document.getElementById("sessionContainer").style.display = 'none';
  document.getElementById("loginContainer").style.display = 'block';
  document.getElementById("userInfo").style.display = 'none';
}

// Función para manejar intentos de login
function loadLoginAttempts() {
  try {
    const attempts = localStorage.getItem(ATTEMPTS_KEY);
    if (attempts) {
      const data = JSON.parse(attempts);
      // Resetear intentos después de 30 minutos
      if (Date.now() - data.timestamp > 30 * 60 * 1000) {
        localStorage.removeItem(ATTEMPTS_KEY);
        loginAttempts = 0;
      } else {
        loginAttempts = data.attempts;
        updateAttemptsWarning();
      }
    }
  } catch (error) {
    console.error('Error cargando intentos:', error);
  }
}

function saveLoginAttempts() {
  try {
    const data = {
      attempts: loginAttempts,
      timestamp: Date.now()
    };
    localStorage.setItem(ATTEMPTS_KEY, JSON.stringify(data));
  } catch (error) {
    console.error('Error guardando intentos:', error);
  }
}

function updateAttemptsWarning() {
  const warningEl = document.getElementById("attemptsWarning");
  if (loginAttempts >= 3) {
    const remaining = MAX_ATTEMPTS - loginAttempts;
    warningEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Atención: Te quedan ${remaining} intentos antes del bloqueo`;
    warningEl.style.display = 'block';
  } else {
    warningEl.style.display = 'none';
  }
}

// Función para bloquear usuario (llamada a API)
async function blockUser(usuario) {
  try {
    const fd = new FormData();
    fd.append("action", "block_user");
    fd.append("usuario", usuario);

    await fetch("https://miweb.com/admin/api/login_clientes.php", { 
      method: "POST", 
      body: fd 
    });
  } catch (error) {
    console.error('Error bloqueando usuario:', error);
  }
}

// Event listeners
document.getElementById("clearDataBtn").addEventListener("click", clearSavedData);
document.getElementById("saveData").addEventListener("change", saveDataIfChecked);

// Mejorar experiencia del PIN en móviles
document.getElementById("pin").addEventListener("input", function(e) {
  this.value = this.value.replace(/[^0-9]/g, '');
});

// Modales
function openModal(message){
  document.getElementById("modalText").textContent = message;
  document.getElementById("loginModal").style.display = "block";
}

function closeModal(){
  document.getElementById("loginModal").style.display = "none";
}

function showLogoutModal() {
  document.getElementById("logoutModal").style.display = "block";
}

function closeLogoutModal() {
  document.getElementById("logoutModal").style.display = "none";
}

function confirmLogout() {
  localStorage.removeItem(SESSION_KEY);
  closeLogoutModal();
  showLoginScreen();
}

function redirectToMovies() {
  window.location.href = "go:peliculas";
}

// Login remoto
document.getElementById("loginForm").addEventListener("submit", async function(e){
  e.preventDefault();
  
  const usuario = document.getElementById("usuario").value.trim();
  const pin = document.getElementById("pin").value.trim();

  if(!usuario || !pin) return openModal("Debes ingresar usuario y PIN");

  if (loginAttempts >= MAX_ATTEMPTS) {
    openModal("Usuario bloqueado por exceso de intentos. Intenta nuevamente en 30 minutos o contacta soporte.", true);
    return;
  }

  try {
    const fd = new FormData();
    fd.append("usuario", usuario);
    fd.append("pin", pin);

    const res = await fetch("https://miweb.com/admin/api/login_clientes.php", { method: "POST", body: fd });
    const data = await res.json();

    if(data.status === "ok"){
      // Login exitoso: resetear intentos y guardar sesión
      localStorage.removeItem(ATTEMPTS_KEY);
      loginAttempts = 0;
      
      const sessionData = {
        usuario: usuario,
        days_left: data.days_left,
        timestamp: Date.now()
      };
      
      localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
      saveDataIfChecked();
      showSessionScreen(sessionData);
      
    } else {
      // Verificar si el usuario está bloqueado/desactivado
      if (data.message && (data.message.includes('bloqueado') || data.message.includes('desactivado') || data.message.includes('estado'))) {
        openModal(data.message, true);
        return;
      }
      
      // Login fallido por PIN incorrecto: incrementar intentos
      if (data.message === "PIN incorrecto") {
        loginAttempts++;
        saveLoginAttempts();
        updateAttemptsWarning();
        
        if (loginAttempts >= MAX_ATTEMPTS) {
          // Bloquear usuario en la API
          const blockResult = await blockUser(usuario);
          openModal("Has excedido el número máximo de intentos. Tu cuenta ha sido bloqueada.", true);
        } else {
          const remaining = MAX_ATTEMPTS - loginAttempts;
          openModal(`PIN incorrecto. Te quedan ${remaining} intentos antes del bloqueo.`);
        }
      } else {
        // Otros errores (usuario no encontrado, etc.)
        openModal(data.message || "Error en el login");
      }
    }
  } catch(err){
    console.error(err);
    openModal("Error al conectar con el servidor");
  }
});

// Inicialización
document.addEventListener("DOMContentLoaded", function() {
  loadLoginAttempts();
  if (!checkActiveSession()) {
    loadSavedData();
    showLoginScreen();
  }
});
</script>

</body>
</html>