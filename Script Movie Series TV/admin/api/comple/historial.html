<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Historial - Cine SRTony</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
body {
  margin: 0;
  font-family: 'Orbitron', sans-serif;
  background-color: #0e0e0e;
  color: #fff;
  padding: 20px;
  font-size: 14px;
}
h1 {
  text-align: center;
  margin-bottom: 20px;
  color: #00ffe0;
  text-shadow: 0 0 5px #00ffe0;
}
.secciones {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-bottom: 20px;
}
.seccion-btn {
  padding: 10px 20px;
  background-color: #111;
  color: #ccc;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Orbitron', sans-serif;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 0 10px rgba(0,255,255,0.1);
}
.seccion-btn:hover {
  background-color: #191919;
  transform: translateY(-2px);
}
.seccion-btn.active {
  background-color: #00ffe0;
  color: #0e0e0e;
  box-shadow: 0 0 15px rgba(0,255,224,0.3);
}
.peliculas {
  display: flex;
  flex-direction: column;
  gap: 20px;
  max-width: 600px;
  margin: 0 auto;
}
.item {
  display: flex;
  align-items: center;
  gap: 15px;
  background-color: #111;
  padding: 10px;
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.3s, transform 0.3s;
  box-shadow: 0 0 15px rgba(0,255,255,0.15);
  position: relative;
}
.item:hover {
  background-color: #191919;
  transform: translateY(-2px);
}
.item img {
  width: 70px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,255,255,0.2);
}
.item-content {
  display: flex;
  flex-direction: column;
  gap: 5px;
  flex: 1;
}
.item-title {
  font-size: 1rem;
  font-weight: 600;
  color: #ccc;
}
.item-type {
  font-size: 0.8rem;
  color: #888;
  font-style: italic;
}
.item-date {
  position: absolute;
  top: 8px;
  right: 10px;
  font-size: 0.7rem;
  color: #666;
}
.no-historial {
  text-align: center;
  font-size: 1.1rem;
  margin-top: 40px;
  color: #888;
}
.controles {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 20px auto;
  flex-wrap: wrap;
}
.btn {
  background: #00ffe0;
  color: #000;
  border: none;
  padding: 10px 20px;
  font-size: 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Orbitron', sans-serif;
  font-weight: 600;
  transition: all 0.3s;
  box-shadow: 0 0 10px rgba(0,255,255,0.5);
}
.btn:hover {
  background: #00e6d4;
  transform: translateY(-2px);
}
.btn.danger {
  background: #ff4444;
  color: #fff;
  box-shadow: 0 0 10px rgba(255,68,68,0.5);
}
.btn.danger:hover {
  background: #cc3333;
}
.loading {
  text-align: center;
  color: #00ffe0;
  margin-top: 20px;
}
.stats {
  text-align: center;
  margin: 15px 0;
  color: #888;
  font-size: 0.9rem;
}
</style>
</head>
<body>
<h1>Historial Reciente</h1>

<div class="secciones">
  <button class="seccion-btn active" onclick="mostrarSeccion('todo')" id="btn-todo">Todo</button>
  <button class="seccion-btn" onclick="mostrarSeccion('peliculas')" id="btn-peliculas">Pel√≠culas</button>
  <button class="seccion-btn" onclick="mostrarSeccion('series')" id="btn-series">Series</button>
</div>

<div class="stats" id="stats"></div>

<div class="controles">
  <button class="btn" onclick="ordenarPorFecha()">üìÖ Ordenar por fecha</button>
  <button class="btn danger" onclick="borrarHistorial()">üóëÔ∏è Borrar Historial</button>
</div>

<div class="loading" id="loading" style="display: none;">
  <i class="fas fa-spinner fa-spin"></i> Cargando historial...
</div>

<div class="peliculas" id="contenedor"></div>
<div class="no-historial" id="mensajeVacio">No has visto ning√∫n contenido a√∫n.</div>

<script>
const contenedor = document.getElementById('contenedor');
const mensajeVacio = document.getElementById('mensajeVacio');
const loading = document.getElementById('loading');
const stats = document.getElementById('stats');

// Obtener historial del localStorage (sistema unificado)
const historialCompleto = JSON.parse(localStorage.getItem('historial_cine') || '[]');

let todosLosItems = [];
let seccionActual = 'todo';
let ordenadoPorFecha = false;

function mostrarSeccion(seccion) {
  // Actualizar botones
  document.querySelectorAll('.seccion-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`btn-${seccion}`).classList.add('active');
  
  seccionActual = seccion;
  
  // Filtrar y mostrar contenido
  const contenidoFiltrado = filtrarPorSeccion(todosLosItems, seccion);
  mostrarHistorial(contenidoFiltrado);
  actualizarEstadisticas(contenidoFiltrado);
}

function filtrarPorSeccion(items, seccion) {
  if (seccion === 'todo') return items;
  return items.filter(item => item.tipo === seccion);
}

function actualizarEstadisticas(items) {
  const peliculas = items.filter(item => item.tipo === 'peliculas').length;
  const series = items.filter(item => item.tipo === 'series').length;
  stats.textContent = `${items.length} elementos ‚Ä¢ ${peliculas} pel√≠culas ‚Ä¢ ${series} series`;
}

function ordenarPorFecha() {
  ordenadoPorFecha = !ordenadoPorFecha;
  const btnOrdenar = document.querySelector('.btn');
  
  if (ordenadoPorFecha) {
    todosLosItems.sort((a, b) => new Date(b.fechaVisto) - new Date(a.fechaVisto));
    btnOrdenar.textContent = 'üìÖ M√°s recientes primero';
  } else {
    todosLosItems.sort((a, b) => new Date(a.fechaVisto) - new Date(b.fechaVisto));
    btnOrdenar.textContent = 'üìÖ M√°s antiguos primero';
  }
  
  const contenidoFiltrado = filtrarPorSeccion(todosLosItems, seccionActual);
  mostrarHistorial(contenidoFiltrado);
}

function borrarHistorial() {
  if (confirm('¬øEst√°s seguro de que quieres borrar todo el historial?')) {
    localStorage.removeItem('historial_cine');
    contenedor.innerHTML = '';
    mensajeVacio.style.display = 'block';
    stats.textContent = '';
    todosLosItems = [];
  }
}

function formatearFecha(fecha) {
  const ahora = new Date();
  const fechaItem = new Date(fecha);
  const diferencia = ahora - fechaItem;
  const minutos = Math.floor(diferencia / (1000 * 60));
  const horas = Math.floor(diferencia / (1000 * 60 * 60));
  const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
  
  if (minutos < 60) {
    return `Hace ${minutos} min`;
  } else if (horas < 24) {
    return `Hace ${horas}h`;
  } else if (dias < 7) {
    return `Hace ${dias} d√≠as`;
  } else {
    return fechaItem.toLocaleDateString('es-ES', { 
      day: 'numeric', 
      month: 'short' 
    });
  }
}

function mostrarHistorial(items) {
  contenedor.innerHTML = '';
  
  if (items.length === 0) {
    mensajeVacio.style.display = 'block';
    return;
  }
  
  mensajeVacio.style.display = 'none';
  
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    div.onclick = () => window.location.href = `go:${item.id}`;
    
    const img = document.createElement('img');
    img.src = `https://image.tmdb.org/t/p/w200${item.poster_path}`;
    img.alt = item.title;
    img.onerror = () => img.src = 'https://via.placeholder.com/70x105/333/ccc?text=Sin+Imagen';
    
    const content = document.createElement('div');
    content.className = 'item-content';
    
    const titulo = document.createElement('div');
    titulo.className = 'item-title';
    titulo.textContent = item.title;
    
    const tipo = document.createElement('div');
    tipo.className = 'item-type';
    tipo.textContent = item.tipo === 'peliculas' ? 'üé¨ Pel√≠cula' : 'üì∫ Serie';
    
    const fecha = document.createElement('div');
    fecha.className = 'item-date';
    fecha.textContent = formatearFecha(item.fechaVisto);
    
    content.appendChild(titulo);
    content.appendChild(tipo);
    div.appendChild(img);
    div.appendChild(content);
    div.appendChild(fecha);
    contenedor.appendChild(div);
  });
}

async function cargarHistorial() {
  if (historialCompleto.length === 0) {
    mensajeVacio.style.display = 'block';
    stats.textContent = 'Historial vac√≠o';
    return;
  }
  
  loading.style.display = 'block';
  todosLosItems = [];
  
  // Si el historial ya tiene estructura de objetos con fecha
  const historialConFechas = historialCompleto.map(item => {
    if (typeof item === 'object') {
      return item; // Ya tiene estructura completa
    } else {
      // Convertir ID simple a objeto con fecha actual
      return {
        id: item,
        fechaVisto: new Date().toISOString()
      };
    }
  });
  
  // Cargar cada ID intentando primero como pel√≠cula y luego como serie
  const promesas = historialConFechas.slice(0, 30).map(async (itemHistorial) => {
    const id = itemHistorial.id;
    
    // Primero intentar como pel√≠cula
    try {
      const response = await fetch(`http://miweb.com/admin/api/moviespe.php?id=${id}`);
      const data = await response.json();
      if (data.status !== "error" && data.title) {
        return {
          id: id,
          title: data.title,
          poster_path: data.poster_path,
          tipo: 'peliculas',
          fechaVisto: itemHistorial.fechaVisto
        };
      }
    } catch (error) {
      // Si falla como pel√≠cula, intentar como serie
    }
    
    // Si no es pel√≠cula, intentar como serie
    try {
      const response = await fetch(`http://miweb.com/admin/api/seriesConnect.php?id=${id}`);
      const data = await response.json();
      
      // Verificar diferentes formatos de respuesta de series
      let serieData = data;
      if (data.data && data.data.serie) {
        serieData = data.data.serie;
      }
      
      if (!data.error && serieData && (serieData.title || serieData.name)) {
        return {
          id: id,
          title: serieData.title || serieData.name || `Serie ${id}`,
          poster_path: serieData.poster_path,
          tipo: 'series',
          fechaVisto: itemHistorial.fechaVisto
        };
      }
    } catch (error) {
      console.log(`No se pudo cargar del historial: ${id}`);
    }
    
    return null;
  });
  
  // Esperar a que se carguen todas las promesas
  const resultados = await Promise.all(promesas);
  
  // Filtrar resultados v√°lidos y ordenar por fecha (m√°s recientes primero)
  todosLosItems = resultados
    .filter(item => item !== null)
    .sort((a, b) => new Date(b.fechaVisto) - new Date(a.fechaVisto));
  
  loading.style.display = 'none';
  
  // Mostrar historial seg√∫n la secci√≥n actual
  const contenidoFiltrado = filtrarPorSeccion(todosLosItems, seccionActual);
  mostrarHistorial(contenidoFiltrado);
  actualizarEstadisticas(contenidoFiltrado);
}

// Cargar historial al iniciar la p√°gina
cargarHistorial();
</script>
</body>
</html>