<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ficha — CorpSRTony</title>

  <style>
    :root{
      --bg:#0b0f19;
      --card:#111726;
      --muted:#9aa4b2;
      --primary:#3b82f6;
      --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .backdrop{position:fixed;inset:0;background:#000 center/cover no-repeat;filter:brightness(0.45) blur(10px);transform:scale(1.05);z-index:-1;}
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(11,15,25,.6),rgba(11,15,25,.9));z-index:-1;}
    .container{max-width:1100px;margin:auto;padding:24px}
    header{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap}
    .poster{width:190px;flex:0 0 190px;border-radius:var(--radius);overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.45);background:#0f172a;aspect-ratio:2/3;display:grid;place-items:center;}
    .poster img{width:100%;height:100%;object-fit:cover;display:block}
    .info{flex:1;min-width:260px}
    h1{margin:0 0 8px;font-size:clamp(22px,3.2vw,34px);line-height:1.1}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .chip{padding:6px 10px;border-radius:999px;font-size:12.5px;background:rgba(59,130,246,.15);color:#cfe0ff;border:1px solid rgba(59,130,246,.35)}
    .chip.warn{background:rgba(245,158,11,.12);color:#ffe2b3;border-color:rgba(245,158,11,.35)}
    .overview{color:#d3d8e2;line-height:1.55}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{border:none;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:600;transition:.2s transform;background:linear-gradient(180deg,var(--primary),#1d4ed8);color:white;}
    .btn:hover{transform:translateY(-2px)}
    .grid{margin-top:22px;display:grid;gap:16px;grid-template-columns:1fr}
    @media (min-width:860px){.grid{grid-template-columns: 1.4fr .6fr;}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);backdrop-filter:blur(6px);}
    .card h3{margin:0 0 10px;font-size:16px;color:#cbd5e1}
    footer{opacity:.7;text-align:center;font-size:12px;margin:26px 0 8px}

    /* Episodios */
    .season{margin-bottom:18px}
    .episodes{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .ep-btn{background:#1e293b;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;border:none;font-size:13px;transition:.2s}
    .ep-btn:hover{background:#334155}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;padding:16px;background:rgba(0,0,0,.9);z-index:50;}
    .modal.open{display:grid}
    .modal-content{width:100%;max-width:960px;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;position:relative;}
    .modal .close{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

    video{width:100%;height:100%;background:#000;outline:none;}
#favBtn {
  display: flex;
  align-items: center;
  gap: 6px;
  background: linear-gradient(180deg,#f43f5e,#b91c1c);
}

#favBtn.active {
  color: #fff;
}

  </style>
</head>
<body>
  <div class="backdrop" id="backdrop"></div>
  <div class="overlay"></div>

  <div class="container">
    <header>
      <figure class="poster">
        <img id="poster" alt="Póster de la serie" loading="lazy" />
      </figure>
	  
      <div class="info">
        <h1 id="title"></h1>
        <div class="meta">
          <span class="chip warn" id="releaseTag"></span>
          <span class="chip" id="categoryTag"></span>
        </div>
        <p class="overview" id="overview"></p>
        <div class="actions">
		  <button class="btn" id="favBtn">♡ Favorito</button>
          <button class="btn" id="watchTrailer">▶ Ver tráiler</button>
        </div>
      </div>
    </header>

    <section class="grid">
      <article class="card">
        <h3>Géneros</h3>
        <div id="genresWrap" class="meta"></div>
        <h3 style="margin-top:14px">Descripción</h3>
        <p id="overview2" class="overview small"></p>
      </article>
    </section>

    <section class="card" style="margin-top:16px">
      <h3>Temporadas</h3>
      <div id="seasons"></div>
    </section>

  </div>

  <!-- Modal Trailer -->
  <div class="modal" id="trailerModal">
    <div class="modal-content">
      <button class="close" id="closeTrailer">✕</button>
      <iframe id="ytFrame" width="100%" height="100%" src="" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
    </div>
  </div>

  <!-- Modal Episodios -->
  <div class="modal" id="videoModal">
    <div class="modal-content">
      <button class="close" id="closeVideo">✕</button>
      <video id="videoPlayer" controls></video>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const API_URL = "http://miweb.com/admin/api/seriesConnect.php?id=119051"; 
    const TMDB_POSTER_BASE = "https://image.tmdb.org/t/p/w500";
    const TMDB_BACKDROP_BASE = "https://image.tmdb.org/t/p/original";
    const $ = s => document.querySelector(s);
    const create = (tag, props={}) => Object.assign(document.createElement(tag), props);

    function formatDate(iso){
      if(!iso) return "Fecha desconocida";
      const d = new Date(iso+"T00:00:00");
      return d.toLocaleDateString("es-CO",{year:'numeric',month:'long',day:'numeric'});
    }

    function renderSerie(m){
      $('#poster').src = m.poster_path ? `${TMDB_POSTER_BASE}${m.poster_path}` : 'https://via.placeholder.com/300x450';
      $('#backdrop').style.backgroundImage = m.backdrop_path ? `url('${TMDB_BACKDROP_BASE}${m.backdrop_path}')` : '';
      $('#title').textContent = m.title;
      $('#releaseTag').textContent = `Estreno: ${formatDate(m.release_date)}`;
      $('#categoryTag').textContent = `Categoría: ${m.category}`;
      $('#overview').textContent = m.overview;
      $('#overview2').textContent = m.overview;

      const genresWrap = $('#genresWrap');
      genresWrap.innerHTML = '';
      m.genres.forEach(g => genresWrap.appendChild(create('span',{className:'chip',textContent:g})));

      const seasons = $('#seasons');
      seasons.innerHTML = '';
      for(const s in m.seasons){
        const seasonDiv = create('div',{className:'season'});
        seasonDiv.appendChild(create('h4',{textContent:`Temporada ${s}`}));

        const epsWrap = create('div',{className:'episodes'});
        for(const e in m.seasons[s]){
          const btn = create('button',{className:'ep-btn',textContent:`Episodio ${e}`});
          btn.onclick = ()=>openVideo(m.seasons[s][e].url);
          epsWrap.appendChild(btn);
        }
        seasonDiv.appendChild(epsWrap);
        seasons.appendChild(seasonDiv);
      }

      $('#watchTrailer').onclick = ()=>openTrailer(m.trailer);
    }

    // Trailer modal
    const trailerModal = $('#trailerModal');
    function openTrailer(id){ $('#ytFrame').src = `https://www.youtube.com/embed/${id}?autoplay=1`; trailerModal.classList.add('open'); }
    function closeTrailer(){ trailerModal.classList.remove('open'); $('#ytFrame').src=''; }
    $('#closeTrailer').onclick = closeTrailer;
    trailerModal.addEventListener('click', e=>{ if(e.target===trailerModal) closeTrailer(); });

    // Episodio modal
    const videoModal = $('#videoModal');
    const videoPlayer = $('#videoPlayer');
    function openVideo(url){
      if(Hls.isSupported() && url.endsWith('.m3u8')){
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(videoPlayer);
      } else {
        videoPlayer.src = url;
      }
      videoModal.classList.add('open');
      videoPlayer.play();
    }
    function closeVideo(){
      videoModal.classList.remove('open');
      videoPlayer.pause();
      videoPlayer.src='';
    }
    $('#closeVideo').onclick = closeVideo;
    videoModal.addEventListener('click', e=>{ if(e.target===videoModal) closeVideo(); });

    // Fetch a la API
    fetch(API_URL)
      .then(res => res.json())
      .then(json => {
        if(json.error){ alert("Error: " + json.message); return; }
        renderSerie(json.data.serie);
      })
      .catch(err => console.error(err));

    $('#year').textContent = new Date().getFullYear();
  </script>
  <script>
// ======================
// FAVORITOS
// ======================
const favBtn = $('#favBtn');
const serieId = 119051; // Reemplaza con el ID dinámico de la serie si lo deseas

// Función para obtener favoritos del localStorage
function getFavoritos(){
  return JSON.parse(localStorage.getItem('favoritos') || '[]');
}

// Función para guardar favoritos en localStorage
function setFavoritos(favs){
  localStorage.setItem('favoritos', JSON.stringify(favs));
}

// Actualizar el botón según si la serie está en favoritos
function actualizarBotonFavorito(){
  const favs = getFavoritos();
  if(favs.includes(serieId)){
    favBtn.textContent = '❤️ Favorito';
    favBtn.classList.add('active');
  }else{
    favBtn.textContent = '♡ Favorito';
    favBtn.classList.remove('active');
  }
}

// Acción al hacer click en el botón
favBtn.onclick = () => {
  let favs = getFavoritos();
  if(favs.includes(serieId)){
    // quitar de favoritos
    favs = favs.filter(id => id !== serieId);
  }else{
    // agregar a favoritos
    favs.push(serieId);
  }
  setFavoritos(favs);
  actualizarBotonFavorito();
}

// Inicializar el estado del botón al cargar
actualizarBotonFavorito();
  </script>
    <script>
// ======================
// HISTORIAL - VERSION CORREGIDA
// ======================

// Obtener ID dinámico de la URL o API
const urlParams = new URLSearchParams(window.location.search);
const serieIdFromUrl = urlParams.get('id');
const serieIdFromApi = API_URL.match(/id=(\d+)/)?.[1];
const serieId = parseInt(serieIdFromUrl || serieIdFromApi || 119051);

console.log('Serie ID detectado:', serieId); // Para depurar

function agregarAlHistorial(id) {
  console.log('Intentando agregar al historial:', id);
  
  let historial = JSON.parse(localStorage.getItem('historial_cine') || '[]');
  console.log('Historial actual:', historial);
  
  // Remover si ya existe (para evitar duplicados)
  historial = historial.filter(item => {
    if (typeof item === 'object') {
      return item.id !== id;
    }
    return item !== id;
  });
  
  // Agregar al principio con fecha
  historial.unshift({
    id: id,
    fechaVisto: new Date().toISOString()
  });
  
  // Mantener solo los últimos 30
  if (historial.length > 30) {
    historial = historial.slice(0, 30);
  }
  
  localStorage.setItem('historial_cine', JSON.stringify(historial));
  console.log('Historial actualizado:', historial);
}

// Sobrescribir completamente la función openVideo
function openVideo(url){
  console.log('openVideo llamado con URL:', url);
  
  // AGREGAR AL HISTORIAL PRIMERO
  agregarAlHistorial(serieId);
  
  // Resto de la lógica original
  if(Hls.isSupported() && url.endsWith('.m3u8')){
    const hls = new Hls();
    hls.loadSource(url);
    hls.attachMedia(videoPlayer);
  } else {
    videoPlayer.src = url;
  }
  videoModal.classList.add('open');
  videoPlayer.play();
}
  </script>
  <script>
// ======================
// AGREGAR AL HISTORIAL AUTOMÁTICAMENTE
// ======================

// Reemplaza con el ID real de la serie o película de esta página
const contenidoId = 119051;  // Por ejemplo, la serie de la ficha actual
const tipoContenido = 'series'; // 'series' o 'peliculas'

// Obtener historial actual
let historial = JSON.parse(localStorage.getItem('historial_cine') || '[]');

// Evitar duplicados
historial = historial.filter(item => {
  if (typeof item === 'object') return item.id !== contenidoId;
  return item !== contenidoId;
});

// Agregar al inicio con fecha
historial.unshift({
  id: contenidoId,
  tipo: tipoContenido,
  fechaVisto: new Date().toISOString()
});

// Mantener solo los últimos 30 elementos
if (historial.length > 30) historial = historial.slice(0, 30);

// Guardar en localStorage
localStorage.setItem('historial_cine', JSON.stringify(historial));
console.log('Historial actualizado automáticamente:', historial);
</script>

</body>
</html>
